<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CO2モニター リアルタイムグラフ</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- date-fns を正しく読み込み -->
    <script src="https://cdn.jsdelivr.net/npm/date-fns@2.29.3/index.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@2.0.0/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
    <!-- Socket.IO をCDNから読み込み -->
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    <style>
        #history-list {
            list-style: none; padding: 0; max-height: 200px;
            overflow-y: auto; border: 1px solid #ddd; border-radius: 5px;
            margin-top: 20px; background-color: #f9f9f9;
        }
        #history-list li {
            padding: 10px; border-bottom: 1px solid #eee; font-size: 0.9em;
            display: flex; justify-content: space-between; align-items: center;
        }
        #history-list li:last-child { border-bottom: none; }
        .data-item-timestamp { color: #666; flex-grow: 1; text-align: left; }
        .data-item-co2, .data-item-temp { font-weight: bold; min-width: 80px; text-align: right; }
        .data-item-co2 { color: #dc3545; }
    </style>
</head>
<body>
    <div class="container">
        <h1>CO2モニター リアルタイムデータ</h1>
        
        <h2>現在のデータ</h2>
        <div class="data-display current-data">
            <p>最終更新日時: <span id="timestamp">--/--/-- --:--:--</span></p>
            <p>CO2濃度: <span id="co2-value">---</span> ppm</p>
            <p>温度: <span id="temperature">--.--</span> °C</p>
        </div>

        <p class="status" id="status">サーバーに接続中...</p>

        <h2>リアルタイムグラフ</h2>
        <div id="chart-container">
            <canvas id="co2TempChart"></canvas>
        </div>

        <h2>履歴データ (直近30件)</h2>
        <ul id="history-list"></ul>
    </div>

    <script type="text/javascript">
        // Socket.IO の初期化
        var socket;
        try {
            socket = io();
        } catch (error) {
            console.error('Socket.IO の初期化に失敗しました:', error);
            document.getElementById('status').innerText = 'Socket.IO読み込みエラー';
            document.getElementById('status').className = 'status disconnected';
        }

        var historyList = document.getElementById('history-list');
        var co2TempChart;
        const MAX_DATA_POINTS = 30;

        // 日付文字列を Date オブジェクトに変換する関数
        function parseDateTime(dateTimeString) {
            // "2025/06/02 14:30:15" 形式を想定
            const parts = dateTimeString.split(' ');
            if (parts.length !== 2) return new Date();
            
            const datePart = parts[0]; // "2025/06/02"
            const timePart = parts[1]; // "14:30:15"
            
            const dateComponents = datePart.split('/');
            const timeComponents = timePart.split(':');
            
            if (dateComponents.length !== 3 || timeComponents.length !== 3) {
                return new Date();
            }
            
            const year = parseInt(dateComponents[0]);
            const month = parseInt(dateComponents[1]) - 1; // JavaScriptの月は0ベース
            const day = parseInt(dateComponents[2]);
            const hour = parseInt(timeComponents[0]);
            const minute = parseInt(timeComponents[1]);
            const second = parseInt(timeComponents[2]);
            
            return new Date(year, month, day, hour, minute, second);
        }

        // グラフの初期化
        function initializeChart() {
            const ctx = document.getElementById('co2TempChart').getContext('2d');
            co2TempChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: [], // X軸: 時刻
                    datasets: [
                        {
                            label: 'CO2濃度 (ppm)',
                            data: [], // Y軸: CO2データ
                            borderColor: 'rgba(220, 53, 69, 1)', // 赤系
                            backgroundColor: 'rgba(220, 53, 69, 0.1)',
                            yAxisID: 'yCO2',
                            tension: 0.1,
                            fill: false
                        },
                        {
                            label: '温度 (°C)',
                            data: [], // Y軸: 温度データ
                            borderColor: 'rgba(0, 123, 255, 1)', // 青系
                            backgroundColor: 'rgba(0, 123, 255, 0.1)',
                            yAxisID: 'yTemp',
                            tension: 0.1,
                            fill: false
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {
                        mode: 'index',
                        intersect: false,
                    },
                    scales: {
                        x: {
                            type: 'time',
                            time: {
                                unit: 'second',
                                displayFormats: {
                                    second: 'HH:mm:ss'
                                },
                                tooltipFormat: 'yyyy/MM/dd HH:mm:ss'
                            },
                            title: {
                                display: true,
                                text: '時刻'
                            }
                        },
                        yCO2: {
                            type: 'linear',
                            display: true,
                            position: 'left',
                            title: {
                                display: true,
                                text: 'CO2濃度 (ppm)'
                            }
                        },
                        yTemp: {
                            type: 'linear',
                            display: true,
                            position: 'right',
                            title: {
                                display: true,
                                text: '温度 (°C)'
                            },
                            grid: {
                                drawOnChartArea: false,
                            }
                        }
                    },
                    plugins: {
                        tooltip: {
                            mode: 'index',
                            intersect: false
                        },
                        legend: {
                            display: true
                        }
                    }
                }
            });
        }

        // Socket.IOイベントハンドラー
        if (socket) {
            socket.on('connect', function() {
                console.log('WebSocketに接続しました');
                document.getElementById('status').innerText = 'サーバーに接続済み';
                document.getElementById('status').className = 'status connected';
            });

            socket.on('disconnect', function() {
                console.log('WebSocketから切断されました');
                document.getElementById('status').innerText = 'サーバーから切断されました';
                document.getElementById('status').className = 'status disconnected';
            });

            socket.on('connect_error', (error) => {
                console.error('WebSocket接続エラー:', error);
                document.getElementById('status').innerText = 'WebSocket接続エラー';
                document.getElementById('status').className = 'status disconnected';
            });

            socket.on('new_co2_data', function(data) {
                console.log('新しいデータを受信:', data);
                
                // 1. 最新データの表示を更新
                document.getElementById('timestamp').innerText = data.timestamp;
                document.getElementById('co2-value').innerText = data.co2;
                document.getElementById('temperature').innerText = data.temp;

                // 2. 履歴リストに追加
                var listItem = document.createElement('li');
                listItem.innerHTML = `
                    <span class="data-item-timestamp">${data.timestamp}</span>
                    <span class="data-item-co2">${data.co2} ${data.co2 !== 'エラー' ? 'ppm' : ''}</span>
                    <span class="data-item-temp">${data.temp} ${data.temp !== 'エラー' ? '°C' : ''}</span>
                `;
                historyList.prepend(listItem);
                
                // 履歴リストの項目数制限
                while (historyList.children.length > MAX_DATA_POINTS) {
                    historyList.removeChild(historyList.lastChild);
                }

                // 3. グラフデータを更新
                if (co2TempChart && data.co2 !== 'エラー' && data.temp !== 'エラー') {
                    try {
                        // 日付文字列をDateオブジェクトに変換
                        const timestamp = parseDateTime(data.timestamp);
                        
                        // データの追加
                        co2TempChart.data.labels.push(timestamp);
                        
                        const co2Val = parseFloat(data.co2);
                        const tempVal = parseFloat(data.temp);
                        
                        // NaNチェック
                        co2TempChart.data.datasets[0].data.push(isNaN(co2Val) ? null : co2Val);
                        co2TempChart.data.datasets[1].data.push(isNaN(tempVal) ? null : tempVal);

                        // データポイント数を制限
                        if (co2TempChart.data.labels.length > MAX_DATA_POINTS) {
                            co2TempChart.data.labels.shift();
                            co2TempChart.data.datasets[0].data.shift();
                            co2TempChart.data.datasets[1].data.shift();
                        }
                        
                        // グラフを更新
                        co2TempChart.update('none'); // アニメーションなしで高速更新
                        
                        console.log('グラフが更新されました');
                    } catch (error) {
                        console.error('グラフ更新エラー:', error);
                    }
                } else if (data.co2 === 'エラー' || data.temp === 'エラー') {
                    console.log('エラーデータのためグラフ更新をスキップ');
                }
            });
        }

        // DOM読み込み完了時にグラフを初期化
        document.addEventListener('DOMContentLoaded', function () {
            console.log('DOMが読み込まれました。グラフを初期化します。');
            initializeChart();
        });
    </script>
</body>
</html>
