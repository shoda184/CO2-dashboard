<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CO2モニター リアルタイムグラフ</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
    <script src="/socket.io/socket.io.js"></script>
    <style>
        /* 既存のインラインスタイルは style.css に移行またはここから削除推奨 */
        #history-list {
            list-style: none; padding: 0; max-height: 200px; /* 高さを少し調整 */
            overflow-y: auto; border: 1px solid #ddd; border-radius: 5px;
            margin-top: 20px; background-color: #f9f9f9;
        }
        #history-list li {
            padding: 10px; border-bottom: 1px solid #eee; font-size: 0.9em;
            display: flex; justify-content: space-between; align-items: center;
        }
        #history-list li:last-child { border-bottom: none; }
        .data-item-timestamp { color: #666; flex-grow: 1; text-align: left; }
        .data-item-co2, .data-item-temp { font-weight: bold; min-width: 80px; text-align: right; }
        .data-item-co2 { color: #dc3545; }
    </style>
</head>
<body>
    <div class="container">
        <h1>CO2モニター リアルタイムデータ</h1>
        
        <h2>現在のデータ</h2>
        <div class="data-display current-data">
            <p>最終更新日時: <span id="timestamp">--/--/-- --:--:--</span></p>
            <p>CO2濃度: <span id="co2-value">---</span> ppm</p>
            <p>温度: <span id="temperature">--.--</span> °C</p>
        </div>

        <p class="status" id="status">サーバーに接続中...</p>

        <h2>リアルタイムグラフ</h2>
        <div id="chart-container">
            <canvas id="co2TempChart"></canvas>
        </div>

        <h2>履歴データ (直近30件)</h2>
        <ul id="history-list">
            </ul>
    </div>

    <script type="text/javascript">
        var socket = io();
        var historyList = document.getElementById('history-list');
        var co2TempChart;
        const MAX_DATA_POINTS = 30; // グラフに表示する最大データ点数

        // グラフの初期化
        function initializeChart() {
            const ctx = document.getElementById('co2TempChart').getContext('2d');
            co2TempChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: [], // X軸: 時刻
                    datasets: [
                        {
                            label: 'CO2濃度 (ppm)',
                            data: [], // Y軸: CO2データ
                            borderColor: 'rgba(220, 53, 69, 1)', // 赤系
                            backgroundColor: 'rgba(220, 53, 69, 0.1)',
                            yAxisID: 'yCO2',
                            tension: 0.1
                        },
                        {
                            label: '温度 (°C)',
                            data: [], // Y軸: 温度データ
                            borderColor: 'rgba(0, 123, 255, 1)', // 青系
                            backgroundColor: 'rgba(0, 123, 255, 0.1)',
                            yAxisID: 'yTemp',
                            tension: 0.1
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: {
                            type: 'time',
                            time: {
                                unit: 'second',
                                displayFormats: {
                                    second: 'HH:mm:ss'
                                },
                                tooltipFormat: 'yyyy/MM/dd HH:mm:ss'
                            },
                            title: {
                                display: true,
                                text: '時刻'
                            }
                        },
                        yCO2: {
                            type: 'linear',
                            display: true,
                            position: 'left',
                            title: {
                                display: true,
                                text: 'CO2濃度 (ppm)'
                            },
                            grid: {
                                drawOnChartArea: false // CO2軸のグリッドは主グリッドと重ならないように
                            }
                        },
                        yTemp: {
                            type: 'linear',
                            display: true,
                            position: 'right',
                            title: {
                                display: true,
                                text: '温度 (°C)'
                            },
                            // グリッドが重ならないように、片方の軸のグリッドのみ表示 (デフォルトはyCO2が優先される)
                        }
                    },
                    plugins: {
                        tooltip: {
                            mode: 'index',
                            intersect: false
                        }
                    }
                }
            });
        }

        // サーバー接続/切断時の処理
        socket.on('connect', function() {
            document.getElementById('status').innerText = 'サーバーに接続済み';
            document.getElementById('status').className = 'status connected';
        });

        socket.on('disconnect', function() {
            document.getElementById('status').innerText = 'サーバーから切断されました';
            document.getElementById('status').className = 'status disconnected';
        });

        socket.on('connect_error', (error) => {
            document.getElementById('status').innerText = 'WebSocket接続エラー';
            document.getElementById('status').className = 'status disconnected';
        });

        // 新しいデータ受信時の処理
        socket.on('new_co2_data', function(data) {
            // 1. 最新データの表示を更新
            document.getElementById('timestamp').innerText = data.timestamp;
            document.getElementById('co2-value').innerText = data.co2;
            document.getElementById('temperature').innerText = data.temp;

            // 2. 履歴リストに追加
            var listItem = document.createElement('li');
            listItem.innerHTML = `
                <span class="data-item-timestamp">${data.timestamp}</span>
                <span class="data-item-co2">${data.co2} ${data.co2 !== 'エラー' ? 'ppm' : ''}</span>
                <span class="data-item-temp">${data.temp} ${data.temp !== 'エラー' ? '°C' : ''}</span>
            `;
            historyList.prepend(listItem);
            while (historyList.children.length > MAX_DATA_POINTS) {
                historyList.removeChild(historyList.lastChild);
            }

            // 3. グラフデータを更新
            if (co2TempChart) {
                const now = dateFns.parse(data.timestamp, 'yyyy/MM/dd HH:mm:ss', new Date());
                
                co2TempChart.data.labels.push(now);
                
                const co2Val = (data.co2 === 'エラー' || isNaN(parseFloat(data.co2))) ? null : parseFloat(data.co2);
                const tempVal = (data.temp === 'エラー' || isNaN(parseFloat(data.temp))) ? null : parseFloat(data.temp);

                co2TempChart.data.datasets[0].data.push(co2Val);
                co2TempChart.data.datasets[1].data.push(tempVal);

                // データポイント数を制限
                if (co2TempChart.data.labels.length > MAX_DATA_POINTS) {
                    co2TempChart.data.labels.shift();
                    co2TempChart.data.datasets[0].data.shift();
                    co2TempChart.data.datasets[1].data.shift();
                }
                co2TempChart.update();
            }
        });

        // DOM読み込み完了時にグラフを初期化
        document.addEventListener('DOMContentLoaded', function () {
            initializeChart();
        });
    </script>
</body>
</html>
